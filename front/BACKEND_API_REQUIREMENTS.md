# Требования к API для дашборда

## Эндпоинт: GET /api/dashboard/stats

### Текущие данные (уже реализованы):
- `total_workouts` - общее количество тренировок за период
- `completed_workouts` - количество завершенных тренировок
- `attendance_rate` - процент посещаемости
- `today_workouts` - количество тренировок на сегодня
- `next_workout` - следующая запланированная тренировка (объект Workout или null)

### Необходимо добавить:

#### 1. Данные цели и дедлайна (`goal`)
```json
{
  "goal": {
    "headline": "Пробежать марафон без остановки",
    "description": "Фокус на выносливости и контроле темпа",
    "milestone": "City2Surf 10km Challenge",
    "days_left": 35,
    "progress": 65
  }
}
```

**Поля:**
- `headline` (string, обязательное) - заголовок цели
- `description` (string, обязательное) - описание цели
- `milestone` (string, обязательное) - название ближайшего события/марафона
- `days_left` (integer, обязательное) - количество дней до дедлайна/события
- `progress` (integer, опциональное, 0-100) - процент выполнения цели

**Источник данных:**
- Данные должны браться из таблицы целей пользователя (если такая есть)
- Или из onboarding данных пользователя (поле `goals`)
- Или из отдельной таблицы `user_goals` / `client_goals`

**Рекомендации по реализации:**
1. Создать таблицу `user_goals` или использовать существующую таблицу целей
2. Поля таблицы:
   - `id` (UUID)
   - `user_id` (UUID, FK)
   - `headline` (string)
   - `description` (text)
   - `milestone` (string) - название события
   - `target_date` (date) - дата дедлайна/события
   - `progress` (integer, 0-100) - процент выполнения
   - `created_at` (timestamp)
   - `updated_at` (timestamp)
3. В эндпоинте `/api/dashboard/stats`:
   - Найти активную цель пользователя (например, ближайшую по дате)
   - Рассчитать `days_left` как разницу между `target_date` и текущей датой
   - Вернуть данные цели в ответе

#### 2. Фото прогресса (`progress_photos`)
```json
{
  "progress_photos": [
    {
      "id": "uuid",
      "date": "2022-10-15T00:00:00Z",
      "url": "https://example.com/photos/photo1.jpg"
    },
    {
      "id": "uuid",
      "date": "2022-06-15T00:00:00Z",
      "url": "https://example.com/photos/photo2.jpg"
    }
  ]
}
```

**Поля:**
- `id` (string, UUID) - идентификатор фото
- `date` (string, ISO 8601) - дата создания фото
- `url` (string) - URL изображения

**Источник данных:**
- Таблица `progress_photos` или `user_photos`
- Связь с пользователем через `user_id`

**Рекомендации по реализации:**
1. Создать таблицу `progress_photos`:
   - `id` (UUID, PK)
   - `user_id` (UUID, FK)
   - `date` (date)
   - `url` (string) - путь к файлу или URL
   - `created_at` (timestamp)
2. В эндпоинте `/api/dashboard/stats`:
   - Получить последние 2-3 фото пользователя, отсортированные по дате (DESC)
   - Вернуть массив фото в ответе

### Пример полного ответа:

```json
{
  "total_workouts": 12,
  "completed_workouts": 10,
  "attendance_rate": 83,
  "today_workouts": 1,
  "next_workout": {
    "id": "uuid",
    "title": "Утренняя пробежка",
    "start": "2026-01-02T08:00:00Z",
    "end": "2026-01-02T09:00:00Z",
    ...
  },
  "goal": {
    "headline": "Пробежать марафон без остановки",
    "description": "Фокус на выносливости и контроле темпа",
    "milestone": "City2Surf 10km Challenge",
    "days_left": 35,
    "progress": 65
  },
  "progress_photos": [
    {
      "id": "uuid-1",
      "date": "2022-10-15T00:00:00Z",
      "url": "/uploads/photos/user123/photo1.jpg"
    },
    {
      "id": "uuid-2",
      "date": "2022-06-15T00:00:00Z",
      "url": "/uploads/photos/user123/photo2.jpg"
    }
  ]
}
```

### Примечания:
- Если данных цели нет, поле `goal` должно быть `null`
- Если фото нет, поле `progress_photos` должно быть пустым массивом `[]` или `null`
- Все даты должны быть в формате ISO 8601 (UTC)

---

## Дополнительные данные для пользователя

### Эндпоинт: GET /api/users/me

#### Необходимо добавить:

#### 1. Часовой пояс пользователя (`timezone`)
```json
{
  "timezone": "Europe/Moscow"
}
```

**Поле:**
- `timezone` (string, опциональное) - часовой пояс пользователя в формате IANA Time Zone Database (например, 'Europe/Moscow', 'America/New_York')

**Источник данных:**
- Поле должно быть в таблице `users` как `timezone` (string, nullable)
- Если поле не заполнено, фронтенд будет использовать часовой пояс браузера автоматически

**Рекомендации по реализации:**
1. Добавить колонку `timezone` в таблицу `users`:
   - `timezone` (string, nullable) - часовой пояс пользователя
2. В эндпоинте `/api/users/me`:
   - Вернуть значение `timezone` из базы данных
   - Если значение `null`, фронтенд автоматически определит часовой пояс браузера

#### 2. Ограничения и травмы (`restrictions`)

**Текущее состояние:**
- Данные уже приходят из эндпоинта `/api/onboarding/` в поле `restrictions` (массив строк)
- Эти данные используются на дашборде для отображения ограничений

**Важно:**
- Если массив `restrictions` пустой или отсутствует, блок "Ограничения и травмы" не должен показывать моковые данные
- Фронтенд теперь не использует моковые данные, если реальных ограничений нет

### Пример полного ответа для User:

```json
{
  "id": "uuid",
  "full_name": "Иван Иванов",
  "email": "ivan@example.com",
  "phone": "+79991234567",
  "role": "client",
  "onboarding_seen": true,
  "locale": "ru",
  "avatar": null,
  "trainer_connection_code": null,
  "phone_verified": true,
  "created_at": "2025-01-01T00:00:00Z",
  "timezone": "Europe/Moscow",
  "trainer": {
    "id": "uuid",
    "full_name": "Тренер Тренеров",
    "email": "trainer@example.com",
    ...
  }
}
```

---

## API для работы с программами тренировок

### Необходимо реализовать следующие endpoints:

#### 1. PUT /api/programs/{program_id}/days/{day_id}
**Обновление дня программы (переименование)**

**Параметры:**
- `program_id` (string, path) - ID программы
- `day_id` (string, path) - ID дня программы

**Тело запроса:**
```json
{
  "name": "Новое название дня"
}
```

**Поля:**
- `name` (string, обязательное) - новое название дня программы

**Ответ:**
- `200 OK` - день программы обновлен
- `404 Not Found` - программа или день не найдены
- `403 Forbidden` - нет доступа к программе

**Пример ответа:**
```json
{
  "id": "uuid",
  "program_id": "uuid",
  "name": "Новое название дня",
  "order": 0,
  "notes": null,
  "owner": "client",
  "source_template_id": null,
  "blocks": [...]
}
```

**Проверка прав доступа:**
- Тренер может обновлять дни в своих программах и программах своих клиентов
- Клиент может обновлять дни только в своих программах

---

#### 2. POST /api/programs/{program_id}/days/{day_id}/blocks/{block_id}/exercises
**Добавление упражнения в блок дня программы**

**Параметры:**
- `program_id` (string, path) - ID программы
- `day_id` (string, path) - ID дня программы
- `block_id` (string, path) - ID блока дня программы

**Тело запроса:**
```json
{
  "title": "Жим лежа",
  "sets": 4,
  "reps": 10,
  "duration": null,
  "rest": 90,
  "weight": 80
}
```

**Поля:**
- `title` (string, обязательное) - название упражнения
- `sets` (integer, обязательное) - количество подходов
- `reps` (integer, опциональное) - количество повторений
- `duration` (integer, опциональное) - длительность в минутах (если упражнение на время)
- `rest` (integer, опциональное) - время отдыха в секундах
- `weight` (float, опциональное) - вес в кг

**Ответ:**
- `201 Created` - упражнение создано
- `404 Not Found` - программа, день или блок не найдены
- `403 Forbidden` - нет доступа к программе

**Пример ответа:**
```json
{
  "id": "uuid",
  "block_id": "uuid",
  "title": "Жим лежа",
  "sets": 4,
  "reps": 10,
  "duration": null,
  "rest": 90,
  "weight": 80.0,
  "order": 0
}
```

**Проверка прав доступа:**
- Тренер может добавлять упражнения в дни своих программ и программ своих клиентов
- Клиент может добавлять упражнения в дни только своих программ

**Рекомендации по реализации:**
1. Проверить существование программы, дня и блока
2. Проверить права доступа пользователя
3. Получить текущий порядок упражнений в блоке
4. Создать новое упражнение с `order = max(order) + 1`
5. Вернуть созданное упражнение

---

#### 3. PUT /api/programs/{program_id}/days/{day_id}/blocks/{block_id}/exercises/{exercise_id}
**Обновление упражнения в блоке дня программы**

**Параметры:**
- `program_id` (string, path) - ID программы
- `day_id` (string, path) - ID дня программы
- `block_id` (string, path) - ID блока дня программы
- `exercise_id` (string, path) - ID упражнения

**Тело запроса:**
```json
{
  "title": "Жим лежа (обновлено)",
  "sets": 5,
  "reps": 12,
  "duration": null,
  "rest": 120,
  "weight": 85
}
```

**Поля (все опциональные):**
- `title` (string) - название упражнения
- `sets` (integer) - количество подходов
- `reps` (integer) - количество повторений
- `duration` (integer) - длительность в минутах
- `rest` (integer) - время отдыха в секундах
- `weight` (float) - вес в кг

**Ответ:**
- `200 OK` - упражнение обновлено
- `404 Not Found` - программа, день, блок или упражнение не найдены
- `403 Forbidden` - нет доступа к программе

**Пример ответа:**
```json
{
  "id": "uuid",
  "block_id": "uuid",
  "title": "Жим лежа (обновлено)",
  "sets": 5,
  "reps": 12,
  "duration": null,
  "rest": 120,
  "weight": 85.0,
  "order": 0
}
```

**Проверка прав доступа:**
- Тренер может обновлять упражнения в днях своих программ и программ своих клиентов
- Клиент может обновлять упражнения в днях только своих программ

---

#### 4. DELETE /api/programs/{program_id}/days/{day_id}/blocks/{block_id}/exercises/{exercise_id}
**Удаление упражнения из блока дня программы**

**Параметры:**
- `program_id` (string, path) - ID программы
- `day_id` (string, path) - ID дня программы
- `block_id` (string, path) - ID блока дня программы
- `exercise_id` (string, path) - ID упражнения

**Ответ:**
- `204 No Content` - упражнение удалено
- `404 Not Found` - программа, день, блок или упражнение не найдены
- `403 Forbidden` - нет доступа к программе

**Проверка прав доступа:**
- Тренер может удалять упражнения из дней своих программ и программ своих клиентов
- Клиент может удалять упражнения из дней только своих программ

**Рекомендации по реализации:**
1. Проверить существование программы, дня, блока и упражнения
2. Проверить права доступа пользователя
3. Удалить упражнение из базы данных
4. Вернуть статус 204 No Content

---

### Важные замечания:

1. **Проверка прав доступа:**
   - Все endpoints должны проверять права доступа пользователя
   - Тренер может работать с программами своих клиентов (проверка через `trainer_id` в таблице `users`)
   - Клиент может работать только со своими программами

2. **Порядок упражнений:**
   - При добавлении нового упражнения нужно автоматически устанавливать `order = max(order) + 1` в рамках блока
   - При удалении упражнения порядок остальных упражнений не нужно пересчитывать (можно оставить как есть)

3. **Валидация данных:**
   - `sets` должно быть положительным числом
   - `reps`, `duration`, `rest`, `weight` должны быть положительными числами или `null`
   - `title` не должен быть пустым

4. **Формат данных:**
   - `rest` хранится в секундах (integer)
   - `duration` хранится в минутах (integer)
   - `weight` хранится в кг (float)

---

## Метрики (`/api/metrics`)

### Создание метрик тела и упражнений

#### 1. POST /api/metrics/body
**Создание метрики тела**

**Тело запроса (JSON):**
```json
{
  "label": "Вес",
  "unit": "кг",
  "target": 75.0
}
```

**Параметры:**
- `label` (string, обязательное) - название метрики (например, "Вес", "Рост", "Процент жира")
- `unit` (string, обязательное) - единица измерения (например, "кг", "см", "%")
- `target` (number, опциональное) - целевое значение метрики

**Ответ:**
- `201 Created` - метрика создана
- `400 Bad Request` - неверные данные
- `401 Unauthorized` - не авторизован

**Пример ответа:**
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "label": "Вес",
  "unit": "кг",
  "target": 75.0,
  "created_at": "2024-01-15T08:00:00"
}
```

**Проверка прав доступа:**
- Пользователь может создавать метрики только для себя
- Метрика автоматически привязывается к текущему пользователю (`user_id`)

---

#### 2. POST /api/metrics/exercise
**Создание метрики упражнения**

**Тело запроса (JSON):**
```json
{
  "label": "Жим лежа",
  "muscle_group": "Грудь"
}
```

**Параметры:**
- `label` (string, обязательное) - название упражнения (например, "Жим лежа", "Приседания")
- `muscle_group` (string, опциональное) - группа мышц (например, "Грудь", "Ноги", "Спина")

**Ответ:**
- `201 Created` - метрика создана
- `400 Bad Request` - неверные данные
- `401 Unauthorized` - не авторизован

**Пример ответа:**
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "label": "Жим лежа",
  "muscle_group": "Грудь",
  "created_at": "2024-01-15T08:00:00"
}
```

**Проверка прав доступа:**
- Пользователь может создавать метрики только для себя
- Метрика автоматически привязывается к текущему пользователю (`user_id`)

**Рекомендации по реализации:**
1. Проверить, что пользователь авторизован
2. Создать запись в таблице `body_metrics` или `exercise_metrics`
3. Вернуть созданную метрику с присвоенным ID
4. Метрики должны быть доступны только их создателю (проверка через `user_id`)

**Важно:**
- Если у пользователя нет метрик, он должен иметь возможность их создать через эти эндпоинты
- Метрики создаются один раз и используются для добавления записей (entries)

